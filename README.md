# `tsgen` Typescript generator for Atek

Atek defines RPC and database schemas using URL IDs and (in some cases) JSON Schemas.

To make life easier, we use `.d.ts` files to define the schemas and API interfaces. This tool generates client and server typescript for using them.

A `.d.ts` file should include a couple of conventions:

- It should start with a "frontmatter" which is a multi-line comment formatted in YAML. This must include an `id` and `type` value.
- The `id` should be a URL without any protocol or extension.
- The `type` should be "api" or "adb-record"
- The metadata can (and should) also include `title` and `description`.
- If `type` is "api" then you can also indicate `transport` but tsgen doesnt make anything interesting for proxy transports.
- It should export a default interface.

## Usage

The `tsgen` tool can be called directly or via `atek` under the `atek tsgen` command.

```
atek tsgen gen-file --in {dts_file_path} --out {output_folder} --env host|node-userland|deno-userland
atek tsgen gen-folder --in {dts_folder_path} --out {output_folder} --env host|node-userland|deno-userland
```

Use `gen-file` to generate TS for a single dts, and `gen-folder` for a folder of dts files.

Choose an `--env` value based on your application:

- `node-userland` A nodejs atek application
- `deno-userland` A deno atek application
- `host` The "atek" project

If using `node-userland`, you will need to install `@atek-cloud/node-rpc` as the generated code depends on it.

## Example

### Input: `ping-api.d.ts`

```typescript
/*
id: atek.cloud/ping-api
type: api
title: Ping API
description: Utility API used for debugging and testing liveness.
*/

export default interface PingApi {
  // Ask for a pong back with the given parameter
  ping (param: number): Promise<number>
}
```

### Output

#### `ping-api.ts`

```typescript

/**
 * File generated by Atek tsgen
 * env=host
 * DO NOT MODIFY
 */
import { URL } from 'url';
import { ApiBrokerClient } from '@atek-cloud/api-broker';

export const ID = "atek.cloud/ping-api";
export const REVISION = undefined;

export default class PingApiClient extends ApiBrokerClient {
  constructor() {
    super("atek.cloud/ping-api")
  }

  ping(param: number): Promise<number> {
    return this.$rpc("ping", [param])
  }
}
```
#### `ping-api.server.ts`

```typescript
/**
 * File generated by Atek tsgen
 * env=host
 * DO NOT MODIFY
 */
import { URL } from 'url';
import { ApiBrokerServer, ApiBrokerServerHandlers } from '@atek-cloud/api-broker';

export const ID = "atek.cloud/ping-api";
export const REVISION = undefined;
export const SCHEMAS = {"$schema":"http://json-schema.org/draft-07/schema#","definitions":{"PingApi":{"type":"object"},"api_PingApi_Ping":{"type":"object","properties":{"params":{"type":"array","items":{"type":"number"},"minItems":1,"maxItems":1},"returns":{"type":"number"}},"required":["params","returns"]}}};
export const EXPORT_MAP = {"methods":{"ping":"#/definitions/api_PingApi_Ping"},"events":{}};

export default class PingApiServer extends ApiBrokerServer {
  ID = "atek.cloud/ping-api";
  REVISION = undefined;

  constructor(handlers: ApiBrokerServerHandlers) {
    super(handlers, SCHEMAS, EXPORT_MAP)
  }
}
```